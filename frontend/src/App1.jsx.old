import React, { useEffect, useMemo, useState } from "react";
import { api, getToken, logout, setToken } from "./api.js";

/**
 * App.jsx — version complète (robuste)
 * - Supprime les écrans blancs : sécurise tous les .map() / données API
 * - Pages: Invité, Concerts, Portfolio, Contact, Connexion, Membre, Admin
 * - Routing simple via URL hash (compatible téléphone)
 */

function getHashPath() {
  const h = window.location.hash || "#/";
  return h.replace(/^#/, "");
}
function setHashPath(p) {
  window.location.hash = `#${p}`;
}

function Nav({ user }) {
  return (
    <div style={styles.nav}>
      <div style={styles.brand} onClick={() => setHashPath("/")}>
        <span style={{ fontWeight: 800 }}>Sound Of Praise</span>
        <span style={styles.badge}>PWA</span>
      </div>

      <div style={styles.row}>
        <button style={styles.btn} onClick={() => setHashPath("/")}>Invité</button>
        <button style={styles.btn} onClick={() => setHashPath("/concerts")}>Concerts</button>
        <button style={styles.btn} onClick={() => setHashPath("/portfolio")}>Portfolio</button>
        <button style={{...styles.btn, ...styles.btnCta}} onClick={() => setHashPath("/contact")}>Contact</button>

        {!user && (
          <button style={{...styles.btn, ...styles.btnPrimary}} onClick={() => setHashPath("/login")}>
            Connexion
          </button>
        )}

        {user && (
          <>
            <button style={styles.btn} onClick={() => setHashPath("/member")}>Espace membre</button>
            {user.role === "admin" && <button style={styles.btn} onClick={() => setHashPath("/admin")}>Gestion</button>}
            <button
              style={styles.btn}
              onClick={() => {
                logout();
                window.location.hash = "#/";
                window.location.reload();
              }}
            >
              Déconnexion
            </button>
          </>
        )}
      </div>
    </div>
  );
}

function Card({ children }) {
  return <div style={styles.card}>{children}</div>;
}

function PublicHome() {
  const [content, setContent] = useState({ about: "", portfolioPdfUrl: "" });
  const [concerts, setConcerts] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let alive = true;

    (async () => {
      try {
        const c = await api.publicContent().catch(() => ({}));
        const list = await api.publicConcerts().catch(() => []);
        if (!alive) return;

        setContent({
          about: typeof c?.about === "string" ? c.about : "Sound Of Praise — Gospel, culture et inclusion.",
          portfolioPdfUrl: typeof c?.portfolioPdfUrl === "string" ? c.portfolioPdfUrl : "",
        });
        setConcerts(Array.isArray(list) ? list : []);
      } finally {
        if (alive) setLoading(false);
      }
    })();

    return () => { alive = false; };
  }, []);

  return (
    <div style={styles.container}>
      <Card>
        <h2 style={styles.h2}>Sound Of Praise</h2>
        <p style={styles.small}>{content.about || "…"}</p>
        <div style={styles.row}>
          <button style={{...styles.btn, ...styles.btnTurq}} onClick={() => setHashPath("/concerts")}>Voir les concerts</button>
          <button style={{...styles.btn, ...styles.btnPrimary}} onClick={() => setHashPath("/portfolio")}>Portfolio</button>
          <button style={{...styles.btn, ...styles.btnCta}} onClick={() => setHashPath("/contact")}>Contacter</button>
        </div>
      </Card>

      <div style={styles.grid2}>
        <Card>
          <h3 style={styles.h3}>Dates de concerts (public)</h3>
          {loading ? <p style={styles.small}>Chargement…</p> : null}
          {!loading && concerts.length === 0 ? <p style={styles.small}>Aucune date publiée.</p> : null}
          <div style={styles.grid}>
            {(Array.isArray(concerts) ? concerts : []).slice(0, 5).map((c) => (
              <Card key={c.id}>
                <div style={{ fontWeight: 700 }}>{c.title || "Concert"}</div>
                <div style={styles.small}>
                  {c.startAt ? new Date(c.startAt).toLocaleString() : "Date à définir"} • {c.place || "—"}
                </div>
              </Card>
            ))}
          </div>
        </Card>

        <Card>
          <h3 style={styles.h3}>Accès rapide</h3>
          <p style={styles.small}>
            • Invités : concerts, portfolio, contact<br />
            • Membres : calendrier + présences + cotisation<br />
            • Admins : gestion membres, événements, stats
          </p>
          <hr style={styles.hr} />
          <div style={styles.row}>
            <button style={styles.btn} onClick={() => setHashPath("/login")}>Se connecter</button>
          </div>
        </Card>
      </div>
    </div>
  );
}

function ConcertsPage() {
  const [concerts, setConcerts] = useState([]);
  const [err, setErr] = useState("");

  useEffect(() => {
    api.publicConcerts()
      .then((data) => setConcerts(Array.isArray(data) ? data : []))
      .catch((e) => setErr(e?.message || "Erreur"));
  }, []);

  return (
    <div style={styles.container}>
      <Card>
        <h2 style={styles.h2}>Concerts (public)</h2>
        {err && <div style={styles.err}>Erreur: {err}</div>}
        {concerts.length === 0 && !err ? <p style={styles.small}>Aucune date publiée.</p> : null}
        <div style={styles.grid}>
          {(Array.isArray(concerts) ? concerts : []).map((c) => (
            <Card key={c.id}>
              <div style={{ fontWeight: 800 }}>{c.title || "Concert"}</div>
              <div style={styles.small}>
                {c.startAt ? new Date(c.startAt).toLocaleString() : "Date à définir"} • {c.place || "—"}
              </div>
            </Card>
          ))}
        </div>
      </Card>
    </div>
  );
}

function PortfolioPage() {
  const [content, setContent] = useState({ about: "", portfolioPdfUrl: "" });

  useEffect(() => {
    api.publicContent().then((c) => {
      setContent({
        about: typeof c?.about === "string" ? c.about : "",
        portfolioPdfUrl: typeof c?.portfolioPdfUrl === "string" ? c.portfolioPdfUrl : "",
      });
    }).catch(()=>{});
  }, []);

  return (
    <div style={styles.container}>
      <Card>
        <h2 style={styles.h2}>Portfolio</h2>
        <p style={styles.small}>PDF de présentation du groupe.</p>
        {content.portfolioPdfUrl ? (
          <a style={{...styles.btnLink, ...styles.btnCta}} href={content.portfolioPdfUrl} target="_blank" rel="noreferrer">
            Ouvrir le PDF
          </a>
        ) : (
          <p style={styles.small}>Pas encore défini. (Admin → Contenu public)</p>
        )}
      </Card>
    </div>
  );
}

function ContactPage() {
  const [form, setForm] = useState({ name: "", email: "", subject: "", message: "" });
  const [status, setStatus] = useState({ ok: false, err: "" });

  async function send() {
    setStatus({ ok: false, err: "" });
    try {
      await api.publicContact(form);
      setStatus({ ok: true, err: "" });
      setForm({ name: "", email: "", subject: "", message: "" });
    } catch (e) {
      setStatus({ ok: false, err: e?.message || "Erreur" });
    }
  }

  return (
    <div style={styles.container}>
      <Card>
        <h2 style={styles.h2}>Contact</h2>
        <div style={styles.grid}>
          <input style={styles.input} placeholder="Nom" value={form.name} onChange={(e)=>setForm(f=>({...f,name:e.target.value}))} />
          <input style={styles.input} placeholder="Email" value={form.email} onChange={(e)=>setForm(f=>({...f,email:e.target.value}))} />
          <input style={styles.input} placeholder="Sujet" value={form.subject} onChange={(e)=>setForm(f=>({...f,subject:e.target.value}))} />
          <textarea style={styles.input} rows={5} placeholder="Message" value={form.message} onChange={(e)=>setForm(f=>({...f,message:e.target.value}))} />
          <button style={{...styles.btn, ...styles.btnCta}} onClick={send}>Envoyer</button>
          {status.ok && <div style={styles.ok}>Message envoyé ✅</div>}
          {status.err && <div style={styles.err}>Erreur: {status.err}</div>}
        </div>
      </Card>
    </div>
  );
}

function LoginPage({ onLogged }) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [err, setErr] = useState("");

  async function submit() {
    setErr("");
    try {
      const r = await api.login(email, password);
      setToken(r.token);
      onLogged(r.user);
      setHashPath(r.user.role === "admin" ? "/admin" : "/member");
    } catch (e) {
      setErr(e?.message || "Identifiants incorrects");
    }
  }

  return (
    <div style={styles.container}>
      <Card>
        <h2 style={styles.h2}>Connexion</h2>
        <p style={styles.small}>Admins multiples possibles (rôle admin).</p>
        <div style={styles.grid}>
          <input style={styles.input} placeholder="Email" value={email} onChange={(e)=>setEmail(e.target.value)} />
          <input style={styles.input} type="password" placeholder="Mot de passe" value={password} onChange={(e)=>setPassword(e.target.value)} />
          {err && <div style={styles.err}>Erreur: {err}</div>}
          <button style={{...styles.btn, ...styles.btnCta}} onClick={submit}>Se connecter</button>
        </div>
      </Card>
    </div>
  );
}

function MemberPage({ user }) {
  const [events, setEvents] = useState([]);
  const [att, setAtt] = useState([]);
  const map = useMemo(() => Object.fromEntries((Array.isArray(att) ? att : []).map(a => [a.eventId, a])), [att]);
  const [msg, setMsg] = useState("");

  async function refresh() {
    setMsg("");
    try {
      const ev = await api.events();
      const at = await api.myAttendance();
      setEvents(Array.isArray(ev) ? ev : []);
      setAtt(Array.isArray(at) ? at : []);
    } catch (e) {
      setMsg(e?.message || "Erreur");
    }
  }

  useEffect(() => { refresh(); }, []);

  async function setStatus(eventId, status) {
    try {
      await api.setAttendance({ eventId, status, comment: "" });
      const at = await api.myAttendance();
      setAtt(Array.isArray(at) ? at : []);
    } catch (e) {
      setMsg(e?.message || "Erreur");
    }
  }

  return (
    <div style={styles.container}>
      <Card>
        <h2 style={styles.h2}>Espace membre</h2>
        <p style={styles.small}>Bonjour <b>{user?.name || "membre"}</b>.</p>
        <div style={styles.row}>
          <button style={styles.btn} onClick={refresh}>Rafraîchir</button>
        </div>
        {msg && <div style={styles.err}>Info: {msg}</div>}
      </Card>

      <Card>
        <h3 style={styles.h3}>Calendrier & présences</h3>
        {events.length === 0 ? <p style={styles.small}>Aucun événement.</p> : null}
        <div style={styles.grid}>
          {(Array.isArray(events) ? events : []).map((e) => (
            <Card key={e.id}>
              <div style={{ fontWeight: 800 }}>{e.title || "Événement"}</div>
              <div style={styles.small}>
                {e.startAt ? new Date(e.startAt).toLocaleString() : "Date à définir"} • {e.place || "—"} • {e.type || "—"}
              </div>
              <div style={styles.small}>Statut: <b>{map[e.id]?.status || "—"}</b></div>
              <div style={{ ...styles.row, marginTop: 10 }}>
                <button style={{...styles.btn, ...styles.btnTurq}} onClick={() => setStatus(e.id, "present")}>Présent</button>
                <button style={styles.btn} onClick={() => setStatus(e.id, "incertain")}>Incertain</button>
                <button style={styles.btn} onClick={() => setStatus(e.id, "absent")}>Absent</button>
              </div>
            </Card>
          ))}
        </div>
      </Card>
    </div>
  );
}

function AdminPage() {
  const [stats, setStats] = useState(null);
  const [users, setUsers] = useState([]);
  const [messages, setMessages] = useState([]);
  const [about, setAbout] = useState("");
  const [pdf, setPdf] = useState("");
  const [newUser, setNewUser] = useState({ name: "", email: "", password: "", role: "member" });
  const [evt, setEvt] = useState({ type: "repetition", title: "Répétition", startAt: "", place: "", notes: "", isPublic: false });
  const [err, setErr] = useState("");

  useEffect(() => {
    // Set default datetime-local value
    const dt = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    const local = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    setEvt(e => ({ ...e, startAt: local }));
    refresh();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  async function refresh() {
    setErr("");
    try {
      const s = await api.adminStats();
      const u = await api.adminUsers();
      const m = await api.adminMessages();
      const c = await api.publicContent();
      setStats(s || null);
      setUsers(Array.isArray(u) ? u : []);
      setMessages(Array.isArray(m) ? m : []);
      setAbout(typeof c?.about === "string" ? c.about : "");
      setPdf(typeof c?.portfolioPdfUrl === "string" ? c.portfolioPdfUrl : "");
    } catch (e) {
      setErr(e?.message || "Erreur");
    }
  }

  async function savePublic() {
    setErr("");
    try {
      await api.adminPublicContent({ about, portfolioPdfUrl: pdf });
      await refresh();
    } catch (e) {
      setErr(e?.message || "Erreur");
    }
  }

  async function createUser() {
    setErr("");
    try {
      await api.adminCreateUser(newUser);
      setNewUser({ name: "", email: "", password: "", role: "member" });
      await refresh();
    } catch (e) {
      setErr(e?.message || "Erreur");
    }
  }

  async function createEvent() {
    setErr("");
    try {
      // datetime-local -> ISO
      const iso = evt.startAt ? new Date(evt.startAt).toISOString() : new Date().toISOString();
      await api.adminCreateEvent({ ...evt, startAt: iso });
      await refresh();
    } catch (e) {
      setErr(e?.message || "Erreur");
    }
  }

  return (
    <div style={styles.container}>
      <Card>
        <h2 style={styles.h2}>Gestion (Admins)</h2>
        <div style={styles.row}>
          <span style={styles.badge}>Admins: {stats?.totalAdmins ?? "—"}</span>
          <span style={styles.badge}>Membres: {stats?.totalMembers ?? "—"}</span>
          <span style={styles.badge}>Événements: {stats?.totalEvents ?? "—"}</span>
        </div>
        {err && <div style={styles.err}>Erreur: {err}</div>}
        <div style={{ ...styles.row, marginTop: 10 }}>
          <button style={styles.btn} onClick={refresh}>Rafraîchir</button>
        </div>
      </Card>

      <div style={styles.grid2}>
        <Card>
          <h3 style={styles.h3}>Contenu public</h3>
          <div style={styles.grid}>
            <label style={styles.small}>À propos</label>
            <textarea style={styles.input} rows={4} value={about} onChange={(e)=>setAbout(e.target.value)} />
            <label style={styles.small}>URL PDF portfolio</label>
            <input style={styles.input} value={pdf} onChange={(e)=>setPdf(e.target.value)} />
            <button style={{...styles.btn, ...styles.btnCta}} onClick={savePublic}>Enregistrer</button>
          </div>
        </Card>

        <Card>
          <h3 style={styles.h3}>Créer un membre / admin</h3>
          <div style={styles.grid}>
            <input style={styles.input} placeholder="Nom" value={newUser.name} onChange={(e)=>setNewUser(u=>({...u,name:e.target.value}))} />
            <input style={styles.input} placeholder="Email" value={newUser.email} onChange={(e)=>setNewUser(u=>({...u,email:e.target.value}))} />
            <input style={styles.input} type="password" placeholder="Mot de passe (min 6)" value={newUser.password} onChange={(e)=>setNewUser(u=>({...u,password:e.target.value}))} />
            <select style={styles.input} value={newUser.role} onChange={(e)=>setNewUser(u=>({...u,role:e.target.value}))}>
              <option value="member">member</option>
              <option value="admin">admin</option>
            </select>
            <button style={{...styles.btn, ...styles.btnTurq}} onClick={createUser}>Créer</button>
          </div>

          <hr style={styles.hr} />
          <h4 style={{margin:"0 0 8px"}}>Utilisateurs</h4>
          <div style={styles.grid}>
            {(Array.isArray(users) ? users : []).map((u) => (
              <Card key={u.id}>
                <div style={{ fontWeight: 800 }}>
                  {u.name} <span style={styles.small}>({u.role})</span>
                </div>
                <div style={styles.small}>{u.email}</div>
              </Card>
            ))}
          </div>
        </Card>
      </div>

      <div style={styles.grid2}>
        <Card>
          <h3 style={styles.h3}>Ajouter un événement</h3>
          <div style={styles.grid}>
            <select style={styles.input} value={evt.type} onChange={(e)=>setEvt(v=>({...v,type:e.target.value}))}>
              <option value="repetition">repetition</option>
              <option value="concert">concert</option>
              <option value="autre">autre</option>
            </select>
            <input style={styles.input} placeholder="Titre" value={evt.title} onChange={(e)=>setEvt(v=>({...v,title:e.target.value}))} />
            <input style={styles.input} type="datetime-local" value={evt.startAt} onChange={(e)=>setEvt(v=>({...v,startAt:e.target.value}))} />
            <input style={styles.input} placeholder="Lieu" value={evt.place} onChange={(e)=>setEvt(v=>({...v,place:e.target.value}))} />
            <input style={styles.input} placeholder="Notes" value={evt.notes} onChange={(e)=>setEvt(v=>({...v,notes:e.target.value}))} />
            <label style={styles.small}>
              <input type="checkbox" checked={!!evt.isPublic} onChange={(e)=>setEvt(v=>({...v,isPublic:e.target.checked}))} /> Public (concert visible invités)
            </label>
            <button style={{...styles.btn, ...styles.btnCta}} onClick={createEvent}>Ajouter</button>
          </div>
        </Card>

        <Card>
          <h3 style={styles.h3}>Messages (contact)</h3>
          {(Array.isArray(messages) ? messages : []).length === 0 ? <p style={styles.small}>Aucun message.</p> : null}
          <div style={styles.grid}>
            {(Array.isArray(messages) ? messages : []).map((m) => (
              <Card key={m.id}>
                <div style={{ fontWeight: 800 }}>{m.subject || "(sans sujet)"}</div>
                <div style={styles.small}>
                  {m.name} • {m.email} • {m.createdAt ? new Date(m.createdAt).toLocaleString() : ""}
                </div>
                <div style={{ marginTop: 8, whiteSpace: "pre-wrap" }}>{m.message}</div>
              </Card>
            ))}
          </div>
        </Card>
      </div>
    </div>
  );
}

function PaymentStatus({ ok }) {
  return (
    <div style={styles.container}>
      <Card>
        <h2 style={styles.h2}>{ok ? "Paiement réussi ✅" : "Paiement annulé"}</h2>
        <p style={styles.small}>Tu peux revenir à l’espace membre.</p>
        <button style={styles.btn} onClick={() => setHashPath("/member")}>Aller à l’espace membre</button>
      </Card>
    </div>
  );
}

export default function App() {
  const [user, setUser] = useState(null);
  const [path, setPath] = useState(getHashPath());

  useEffect(() => {
    const onHash = () => setPath(getHashPath());
    window.addEventListener("hashchange", onHash);
    return () => window.removeEventListener("hashchange", onHash);
  }, []);

  useEffect(() => {
    if (getToken()) {
      api.me().then(setUser).catch(() => {
        logout();
        setUser(null);
      });
    }
  }, []);

  let page = null;
  if (path === "/" || path === "") page = <PublicHome />;
  else if (path === "/concerts") page = <ConcertsPage />;
  else if (path === "/portfolio") page = <PortfolioPage />;
  else if (path === "/contact") page = <ContactPage />;
  else if (path === "/login") page = <LoginPage onLogged={setUser} />;
  else if (path === "/member") page = user ? <MemberPage user={user} /> : <LoginPage onLogged={setUser} />;
  else if (path === "/admin") page = user?.role === "admin" ? <AdminPage /> : <LoginPage onLogged={setUser} />;
  else if (path === "/paiement/success") page = <PaymentStatus ok />;
  else if (path === "/paiement/cancel") page = <PaymentStatus ok={false} />;
  else page = <PublicHome />;

  return (
    <>
      <Nav user={user} />
      {page}
    </>
  );
}

const palette = {
  bg: "#F6F7F8",
  night: "#0B132B",
  turq: "#2EC4B6",
  gold: "#D4AF37",
  border: "rgba(11,19,43,0.12)",
  muted: "#64748b",
};

const styles = {
  nav: {
    position: "sticky",
    top: 0,
    padding: "12px 16px",
    background: "rgba(246,247,248,0.92)",
    backdropFilter: "blur(10px)",
    borderBottom: `1px solid ${palette.border}`,
    display: "flex",
    justifyContent: "space-between",
    gap: 12,
    alignItems: "center",
    flexWrap: "wrap",
    zIndex: 10,
  },
  brand: { display: "flex", gap: 10, alignItems: "center", cursor: "pointer" },
  badge: { fontSize: 12, padding: "4px 8px", borderRadius: 999, border: `1px solid ${palette.border}`, color: palette.muted },
  container: { maxWidth: 980, margin: "0 auto", padding: 16 },
  card: { background: "#fff", border: `1px solid ${palette.border}`, borderRadius: 16, padding: 14 },
  grid: { display: "grid", gap: 12 },
  grid2: { display: "grid", gap: 12, gridTemplateColumns: "1fr" },
  row: { display: "flex", gap: 10, alignItems: "center", flexWrap: "wrap" },
  btn: { border: `1px solid ${palette.border}`, background: "#fff", color: palette.night, padding: "10px 12px", borderRadius: 12, cursor: "pointer", fontWeight: 650 },
  btnPrimary: { background: palette.night, color: "#fff", borderColor: palette.night },
  btnTurq: { background: palette.turq, color: "#062f2a", borderColor: "#1bb8a9" },
  btnCta: { background: palette.gold, color: "#1b1301", borderColor: "#caa12c" },
  btnLink: { display: "inline-block", textDecoration: "none", textAlign: "center", ...this },
  input: { width: "100%", padding: "10px 12px", borderRadius: 12, border: `1px solid ${palette.border}`, background: "#fff", color: palette.night },
  small: { fontSize: 12.5, color: palette.muted },
  h2: { marginTop: 0, marginBottom: 8 },
  h3: { marginTop: 0, marginBottom: 8 },
  hr: { border: 0, borderTop: `1px solid ${palette.border}`, margin: "14px 0" },
  err: { fontSize: 13, color: "#b91c1c", marginTop: 8 },
  ok: { fontSize: 13, color: "#166534", marginTop: 8 },
};

// Responsive tweak
if (typeof window !== "undefined") {
  const mq = window.matchMedia("(min-width: 840px)");
  const apply = () => { styles.grid2.gridTemplateColumns = mq.matches ? "1fr 1fr" : "1fr"; };
  apply();
  mq.addEventListener?.("change", apply);
}
